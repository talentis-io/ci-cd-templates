name: Notify Webhook

on:
  workflow_call:
    inputs:
      repo_name:
        required: true
        type: string
      branch_name:
        required: true
        type: string

jobs:
  send-kpi:
    runs-on: ubuntu-latest
    steps:
      - name: Notify backend webhook
        if: always()
        env:
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
          REPO_NAME: ${{ inputs.repo_name }}
          BRANCH_NAME: ${{ inputs.branch_name }}
          RUN_ID: ${{ github.run_id }}
          RUN_NUMBER: ${{ github.run_number }}
          SHA: ${{ github.sha }}
        run: |
          TS=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          PAYLOAD=$(jq -n \
            --arg serverUrl "https://sonarqube.example.com" \
            --arg taskId "AXouyxDpizdp4B1K" \
            --arg projectKey "$REPO_NAME" \
            --arg projectName "$REPO_NAME" \
            --arg projectUrl "https://sonarqube.example.com/dashboard?id=$REPO_NAME" \
            --arg branchName "$BRANCH_NAME" \
            --arg sha "$SHA" \
            --arg run_id "$RUN_ID" \
            --arg run_number "$RUN_NUMBER" \
            '{
              serverUrl: $serverUrl,
              taskId: $taskId,
              project: {
                key: $projectKey,
                name: $projectName,
                url: $projectUrl
              },
              branch: {
                name: $branchName,
                type: "LONG",
                isMain: "true",
                url: ($projectUrl + "&branch=" + $branchName)
              },
              analysis: {
                analysisId: $run_id,
                date: (now | todateiso8601),
                buildString: ("gha-build-" + $run_number),
                revision: $sha
              },
              qualityGate: {
                name: "SonarQube Way",
                status: "OK",
                conditions: []
              },
              measures: []
            }')

          ATTEMPTS=0; MAX=3; S=2
          until [ $ATTEMPTS -ge $MAX ]; do
            CODE=$(curl -sS -o /tmp/resp.txt -w "%{http_code}" -X POST "$WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              --data "$PAYLOAD" || echo "000")

            if [ "$CODE" = "200" ] || [ "$CODE" = "201" ] || [ "$CODE" = "204" ]; then
              echo "Webhook OK (HTTP $CODE)"
              cat /tmp/resp.txt || true
              exit 0
            fi
            echo "Webhook failed (HTTP $CODE)"
            cat /tmp/resp.txt || true
            ATTEMPTS=$((ATTEMPTS+1))
            echo "Retry $ATTEMPTS/$MAX in ${S}s…"
            sleep $S
            S=$((S*2))
          done

          echo "⚠ Webhook not delivered after $MAX attempts (non-blocking)."
